volumes:
    libsql-data:
        name: openstatus-libsql-data

networks:
    openstatus-network:
        driver: bridge

services:
    # External services
    libsql:
        container_name: openstatus-libsql
        image: ghcr.io/tursodatabase/libsql-server:latest
        volumes:
            - libsql-data:/var/lib/sqld
        networks:
            - openstatus-network
        environment:
            - SQLD_NODE=primary
        healthcheck:
            test: ["CMD-SHELL", "perl -e 'use IO::Socket::INET; exit(IO::Socket::INET->new(PeerAddr=>\"127.0.0.1:8080\",Timeout=>1) ? 0 : 1);'"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        restart: unless-stopped

    # Internal Services
    workflows:
        container_name: openstatus-workflows
        build:
            context: .
            dockerfile: apps/workflows/Dockerfile
        networks:
            - openstatus-network
        image: openstatus/workflows:latest
        environment:
            - DATABASE_URL=http://libsql:8080
            - PORT=3000
            - DATABASE_URL
            - DATABASE_AUTH_TOKEN
            - RESEND_API_KEY
            - AUTH_SECRET
            - SELF_HOST
            - AUTH_GOOGLE_ID
            - AUTH_GOOGLE_SECRET
            - CRON_SECRET
            - SUPER_ADMIN_TOKEN
            - FLY_REGION
            - SLACK_SUPPORT_WEBHOOK_URL
            - TELEGRAM_BOT_TOKEN
            - NODE_ENV
            - NEXT_PUBLIC_URL
        depends_on:
            libsql:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3000/ping || exit 1"]
            interval: 15s
            timeout: 10s
            retries: 3
            start_period: 30s
        restart: unless-stopped

    server:
        container_name: openstatus-server
        build:
            context: .
            dockerfile: apps/server/Dockerfile
        networks:
            - openstatus-network
        image: openstatus/server:latest
        ports:
            - "3001:3000"
        environment:
            - DATABASE_URL=http://libsql:8080
            - PORT=3000
            - DATABASE_URL
            - DATABASE_AUTH_TOKEN
            - RESEND_API_KEY
            - AUTH_SECRET
            - SELF_HOST
            - AUTH_GOOGLE_ID
            - AUTH_GOOGLE_SECRET
            - CRON_SECRET
            - SUPER_ADMIN_TOKEN
            - FLY_REGION
            - SLACK_SUPPORT_WEBHOOK_URL
            - TELEGRAM_BOT_TOKEN
            - NODE_ENV
            - NEXT_PUBLIC_URL
        depends_on:
            libsql:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3000/ping || exit 1"]
            interval: 15s
            timeout: 10s
            retries: 3
            start_period: 30s
        restart: unless-stopped

    private-location:
        container_name: openstatus-private-location
        build:
            context: apps/private-location
            dockerfile: Dockerfile
        networks:
            - openstatus-network
        image: openstatus/private-location:latest
        ports:
            - "8081:8080"
        environment:
            - DB_URL=http://libsql:8080
            - TINYBIRD_URL=http://tinybird-local:7181
            - GIN_MODE=release
            - PORT=8080
            - DATABASE_URL
            - DATABASE_AUTH_TOKEN
            - RESEND_API_KEY
            - AUTH_SECRET
            - SELF_HOST
            - AUTH_GOOGLE_ID
            - AUTH_GOOGLE_SECRET
            - CRON_SECRET
            - SUPER_ADMIN_TOKEN
            - FLY_REGION
            - SLACK_SUPPORT_WEBHOOK_URL
            - TELEGRAM_BOT_TOKEN
            - NODE_ENV
            - NEXT_PUBLIC_URL
        depends_on:
            server:
                condition: service_started
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
            interval: 15s
            timeout: 10s
            retries: 3
            start_period: 30s
        restart: unless-stopped

    dashboard:
        container_name: openstatus-dashboard
        build:
            context: .
            dockerfile: apps/dashboard/Dockerfile
        image: openstatus/dashboard:latest
        networks:
            - openstatus-network
        ports:
            - "3002:3000"
        environment:
            - DATABASE_URL=http://libsql:8080
            - PORT=3000
            - HOSTNAME=0.0.0.0
            - AUTH_TRUST_HOST=true
            - DATABASE_URL
            - DATABASE_AUTH_TOKEN
            - RESEND_API_KEY
            - AUTH_SECRET
            - SELF_HOST
            - AUTH_GOOGLE_ID
            - AUTH_GOOGLE_SECRET
            - CRON_SECRET
            - SUPER_ADMIN_TOKEN
            - FLY_REGION
            - SLACK_SUPPORT_WEBHOOK_URL
            - TELEGRAM_BOT_TOKEN
            - NODE_ENV
            - NEXT_PUBLIC_URL
        depends_on:
            libsql:
                condition: service_healthy
            server:
                condition: service_started
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
            interval: 15s
            timeout: 10s
            retries: 3
            start_period: 45s
        restart: unless-stopped

    status-page:
        container_name: openstatus-status-page
        build:
            context: .
            dockerfile: apps/status-page/Dockerfile
        networks:
            - openstatus-network
        image: openstatus/status-page:latest
        ports:
            - "3003:3000"
        environment:
            - DATABASE_URL=http://libsql:8080
            - PORT=3000
            - HOSTNAME=0.0.0.0
            - AUTH_TRUST_HOST=true
            - DATABASE_URL
            - DATABASE_AUTH_TOKEN
            - RESEND_API_KEY
            - AUTH_SECRET
            - SELF_HOST
            - AUTH_GOOGLE_ID
            - AUTH_GOOGLE_SECRET
            - CRON_SECRET
            - SUPER_ADMIN_TOKEN
            - FLY_REGION
            - SLACK_SUPPORT_WEBHOOK_URL
            - TELEGRAM_BOT_TOKEN
            - NODE_ENV
            - NEXT_PUBLIC_URL
        depends_on:
            libsql:
                condition: service_healthy
            server:
                condition: service_started
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
            interval: 15s
            timeout: 10s
            retries: 3
            start_period: 45s
        restart: unless-stopped
